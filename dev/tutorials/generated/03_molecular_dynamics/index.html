<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Molecular Dynamics · Detangle.jl</title><meta name="title" content="Molecular Dynamics · Detangle.jl"/><meta property="og:title" content="Molecular Dynamics · Detangle.jl"/><meta property="twitter:title" content="Molecular Dynamics · Detangle.jl"/><meta name="description" content="Documentation for Detangle.jl."/><meta property="og:description" content="Documentation for Detangle.jl."/><meta property="twitter:description" content="Documentation for Detangle.jl."/><script data-outdated-warner src="../../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../../assets/documenter.js"></script><script src="../../../search_index.js"></script><script src="../../../siteinfo.js"></script><script src="../../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../../../">Detangle.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../../">Home</a></li><li><a class="tocitem" href="../../../getting_started/">Getting Started</a></li><li><span class="tocitem">Manual</span><ul><li><a class="tocitem" href="../../../manual/overview/">Overview</a></li><li><a class="tocitem" href="../../../manual/concepts/">Concepts and Semantics</a></li><li><a class="tocitem" href="../../../manual/api_reference/">API Reference</a></li></ul></li><li><span class="tocitem">Tutorials</span><ul><li><a class="tocitem" href="../../overview/">Overview</a></li><li><a class="tocitem" href="../01_basic_dag/">Basic Dag</a></li><li><a class="tocitem" href="../02_block_sum/">Block Sum</a></li><li class="is-active"><a class="tocitem" href>Molecular Dynamics</a><ul class="internal"><li><a class="tocitem" href="#Visualization"><span>Visualization</span></a></li></ul></li><li><a class="tocitem" href="../04_histogram/">Histogram</a></li></ul></li><li><a class="tocitem" href="../../../comparison/">Comparison</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Tutorials</a></li><li class="is-active"><a href>Molecular Dynamics</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Molecular Dynamics</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/eswagel/Detangle.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/eswagel/Detangle.jl/blob/main/docs/src/tutorials/generated/03_molecular_dynamics.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Molecular-Dynamics"><a class="docs-heading-anchor" href="#Molecular-Dynamics">Molecular Dynamics</a><a id="Molecular-Dynamics-1"></a><a class="docs-heading-anchor-permalink" href="#Molecular-Dynamics" title="Permalink"></a></h1><p>This page is auto-generated from <code>examples/03_molecular_dynamics.jl</code>.</p><p>The tutorial code is rendered only (not executed during docs build).</p><pre><code class="language-julia hljs">using Detangle

include(joinpath(@__DIR__, &quot;md_utils.jl&quot;))

envint(key, default) = parse(Int, get(ENV, key, string(default)))
envbool(key, default) = lowercase(get(ENV, key, default ? &quot;true&quot; : &quot;false&quot;)) in (&quot;1&quot;, &quot;true&quot;, &quot;yes&quot;, &quot;on&quot;)

# Simplified MD demo: per-block force/integration tasks with spatial binning.
# Tasks declare which arrays/regions they read and write; Detangle uses that
# information to order dependent work and expose safe parallelism.

# === Parameters ===
# n: number of particles.
# box: side length of the square domain.
# n_cells_x/n_cells_y: spatial bins for neighbor lookup (more cells =&gt; fewer particles per cell).
# n_particles_per_thread: number of particles per task block (smaller =&gt; more tasks).
# dt: timestep size for integration.
# particle_radius: hard-sphere radius used for collision checks.
# cutoff: interaction radius (set to 2x particle_radius).
# k_spring: stiffness for the hard-sphere penalty force.
# speed_mean/speed_std: mean and stddev of initial speed; direction is random.
# steps: number of simulation steps to run.
# save_frames: toggle writing CSV frames for animation.
# frame_stride: save every Nth frame when save_frames=true.
# progress_stride: print progress every N steps.
n = 500
box = 10.0
n_particles_per_thread = 10
dt = 0.005
particle_radius = 0.2
cutoff = 2 * particle_radius
n_cells_x = n_cells_y = ceil(Int, box / cutoff)
k_spring = -10.0
speed_mean = 1.0
speed_std = 0.2
steps = envint(&quot;DETANGLE_MD_STEPS&quot;, 5000)
save_frames = envbool(&quot;DETANGLE_MD_SAVE_FRAMES&quot;, true)
frame_stride = envint(&quot;DETANGLE_MD_FRAME_STRIDE&quot;, 10)
progress_stride = envint(&quot;DETANGLE_MD_PROGRESS_STRIDE&quot;, 50)
output_dir = joinpath(@__DIR__, &quot;output&quot;)

println(&quot;initializing particles...&quot;)
posx, posy, velx, vely, forcex, forcey, blocks = init_particles_simple(
    n,
    box;
    block_size=n_particles_per_thread,
    speed_mean=speed_mean,
    speed_std=speed_std,
)
blocks = particle_blocks(n, n_particles_per_thread)
cutoff2 = cutoff * cutoff
soft = 1.0e-6
# Spatial bins for neighbor lookup.
cell_size = box / max(n_cells_x, n_cells_y)
neighbor_radius = ceil(Int, cutoff / cell_size)
cells = [Int[] for _ in 1:(n_cells_x * n_cells_y)]
cell_of = zeros(Int, n)
neighbors = [Int[] for _ in 1:(n_cells_x * n_cells_y)]
build_neighbor_cells!(neighbors, n_cells_x, n_cells_y, neighbor_radius)
bin_ctx = init_bin_context(n_cells_x * n_cells_y)

function apply_bounce!(x, v, box)
    # Reflect off walls to keep particles in-bounds.
    if !isfinite(x) || !isfinite(v)
        return x, v
    end
    while x &lt; 0 || x &gt; box
        if x &lt; 0
            x = -x
            v = -v
        elseif x &gt; box
            x = 2 * box - x
            v = -v
        end
    end
    return x, v
end

# Compute hard-sphere penalty forces using spatial bins for neighbor lookup.
function accumulate_forces!(r, cell_of, neighbors, cells, posx, posy, forcex, forcey, box, cutoff2, soft, particle_radius, k_spring)
    for i in r
        xi = posx[i]
        yi = posy[i]
        fx = 0.0
        fy = 0.0
        cid = cell_of[i]
        for ncell in neighbors[cid]
            for j in cells[ncell]
                j == i &amp;&amp; continue
                dx = posx[j] - xi
                dy = posy[j] - yi
                if dx &gt; box / 2
                    dx -= box
                elseif dx &lt; -box / 2
                    dx += box
                end
                if dy &gt; box / 2
                    dy -= box
                elseif dy &lt; -box / 2
                    dy += box
                end
                r2 = dx * dx + dy * dy
                if r2 &lt; cutoff2
                    r = sqrt(max(r2, 1.0e-6))
                    overlap = 2 * particle_radius - r
                    if overlap &gt; 0
                        f = k_spring * overlap / r
                        fx += f * dx
                        fy += f * dy
                    end
                end
            end
        end
        forcex[i] = fx
        forcey[i] = fy
    end
end

function integrate_position!(r, posx, posy, velx, vely, forcex, forcey, dt, box)
    # Velocity-Verlet position update (half-step velocity + full position).
    for i in r
        velx[i] += 0.5 * dt * forcex[i]
        vely[i] += 0.5 * dt * forcey[i]
        posx[i], velx[i] = apply_bounce!(posx[i] + dt * velx[i], velx[i], box)
        posy[i], vely[i] = apply_bounce!(posy[i] + dt * vely[i], vely[i], box)
    end
end

function integrate_velocity!(r, velx, vely, forcex, forcey, dt)
    # Finish the velocity half-step after recomputing forces.
    for i in r
        velx[i] += 0.5 * dt * forcex[i]
        vely[i] += 0.5 * dt * forcey[i]
    end
end

println(&quot;building DAG...&quot;)
# The DAG is built once and reused each step. Each block contributes four tasks:
#   1) forces-$bi: compute forces for particles in r using spatial bins.
#   2) integrate-pos-$bi: advance positions with a half-step velocity update.
#   3) forces2-$bi: recompute forces after positions update.
#   4) integrate-vel-$bi: finish the velocity update.
# Access annotations describe which regions are read or written so Detangle can
# order dependent tasks and run independent blocks in parallel.
dag = Detangle.@dag begin
    Detangle.@spawn Detangle.@task &quot;bin-1&quot; begin
        Detangle.@access posx Read() Whole()
        Detangle.@access posy Read() Whole()
        Detangle.@access cells Write() Whole()
        Detangle.@access cell_of Write() Whole()
        # Parallel binning builds per-cell particle lists.
        bin_particles_auto!(cells, cell_of, posx, posy, box, n_cells_x, n_cells_y, bin_ctx)
    end
    for (bi, r) in enumerate(blocks)
        Detangle.@spawn Detangle.@task &quot;forces-$bi&quot; begin
            Detangle.@access posx Read() Whole()
            Detangle.@access posy Read() Whole()
            Detangle.@access cells Read() Whole()
            Detangle.@access cell_of Read() Whole()
            Detangle.@access neighbors Read() Whole()
            Detangle.@access forcex Write() Block(r)
            Detangle.@access forcey Write() Block(r)
            accumulate_forces!(r, cell_of, neighbors, cells, posx, posy, forcex, forcey, box, cutoff2, soft, particle_radius, k_spring)
        end
        Detangle.@spawn Detangle.@task &quot;integrate-pos-$bi&quot; begin
            Detangle.@access posx ReadWrite() Block(r)
            Detangle.@access posy ReadWrite() Block(r)
            Detangle.@access velx ReadWrite() Block(r)
            Detangle.@access vely ReadWrite() Block(r)
            Detangle.@access forcex Read() Block(r)
            Detangle.@access forcey Read() Block(r)
            integrate_position!(r, posx, posy, velx, vely, forcex, forcey, dt, box)
        end
    end
    Detangle.@spawn Detangle.@task &quot;bin-2&quot; begin
        Detangle.@access posx Read() Whole()
        Detangle.@access posy Read() Whole()
        Detangle.@access cells Write() Whole()
        Detangle.@access cell_of Write() Whole()
        bin_particles_auto!(cells, cell_of, posx, posy, box, n_cells_x, n_cells_y, bin_ctx)
    end
    for (bi, r) in enumerate(blocks)
        Detangle.@spawn Detangle.@task &quot;forces2-$bi&quot; begin
            Detangle.@access posx Read() Whole()
            Detangle.@access posy Read() Whole()
            Detangle.@access cells Read() Whole()
            Detangle.@access cell_of Read() Whole()
            Detangle.@access neighbors Read() Whole()
            Detangle.@access forcex Write() Block(r)
            Detangle.@access forcey Write() Block(r)
            accumulate_forces!(r, cell_of, neighbors, cells, posx, posy, forcex, forcey, box, cutoff2, soft, particle_radius, k_spring)
        end
        Detangle.@spawn Detangle.@task &quot;integrate-vel-$bi&quot; begin
            Detangle.@access velx ReadWrite() Block(r)
            Detangle.@access vely ReadWrite() Block(r)
            Detangle.@access forcex Read() Block(r)
            Detangle.@access forcey Read() Block(r)
            integrate_velocity!(r, velx, vely, forcex, forcey, dt)
        end
    end
end

println(&quot;tasks: &quot;, length(dag.tasks))

println(&quot;starting simulation...&quot;)
if save_frames
    mkpath(output_dir)
    for path in readdir(output_dir; join=true)
        if occursin(r&quot;frame_\\d+\\.csv$&quot;, path)
            rm(path)
        end
    end
end
for step in 1:steps
    execute_threads!(dag)

    if step % progress_stride == 0 || step == 1 || step == steps
        println(&quot;step &quot;, step, &quot;/&quot;, steps)
    end

    if save_frames &amp;&amp; (step % frame_stride == 0)
        mkpath(output_dir)
        path = joinpath(output_dir, &quot;frame_&quot; * lpad(string(step), 4, &#39;0&#39;) * &quot;.csv&quot;)
        write_frame_csv(path, posx, posy)
    end
end

println(&quot;completed &quot;, steps, &quot; steps with &quot;, 4 * length(blocks) + 2, &quot; tasks/step&quot;)
println(&quot;frames written to &quot;, output_dir)
include(joinpath(@__DIR__, &quot;tools&quot;, &quot;build_md_animation.jl&quot;))
</code></pre><h2 id="Visualization"><a class="docs-heading-anchor" href="#Visualization">Visualization</a><a id="Visualization-1"></a><a class="docs-heading-anchor-permalink" href="#Visualization" title="Permalink"></a></h2><p>Animation generated during docs build from MD frame CSVs.</p><iframe src="03_molecular_dynamics_animation.html" width="720" height="760" style="border:1px solid #d0d7de;"></iframe><p><a href="../03_molecular_dynamics_animation.html">Open animation in a new tab</a></p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../02_block_sum/">« Block Sum</a><a class="docs-footer-nextpage" href="../04_histogram/">Histogram »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.16.1 on <span class="colophon-date" title="Tuesday 24 February 2026 22:10">Tuesday 24 February 2026</span>. Using Julia version 1.12.5.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
